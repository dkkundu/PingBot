{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-12">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-10">
        <div>
            <h1 class="text-4xl font-extrabold tracking-tight text-gray-900">Message Details</h1>
           
        </div>
        <div class="flex gap-3">
         
            <a href="{{ url_for('alert.edit_sample', id=sample.id) }}"
               class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm transition font-medium">
                ‚úè Edit
            </a>
            <button id="testMessageButton"
               class="px-5 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-sm transition font-medium">
                ‚úâÔ∏è Test Message
            </button>
            <a href="{{ url_for('alert.delete_sample', id=sample.id) }}"
               class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-sm transition font-medium"
               onclick="return confirm('Are you sure you want to delete this alert sample?')">
                üóë Delete
            </a>
        </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
        <!-- Top Header Section -->
        <div class="bg-gradient-to-r from-indigo-600 to-blue-500 px-8 py-6 text-white">
            <h2 class="text-2xl font-bold">{{ sample.title }}</h2>
            <p class="mt-1 opacity-90">{{ (sample.body | striptags)[:120] }}{% if sample.body|length > 120 %}...{% endif %}</p>
        </div>

        <!-- Details Grid -->
        <div class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-gray-800">
            <!-- Company Name -->
            <div>
                <p class="text-sm font-medium text-gray-500">Company Name</p>
                <p class="mt-1 text-lg font-semibold">{{ sample.company_name or 'N/A' }}</p>
            </div>

            <!-- Sender Name -->
            <div>
                <p class="text-sm font-medium text-gray-500">Sender Name</p>
                <p class="mt-1 text-lg font-semibold">{{ sample.sender_name or 'N/A' }}</p>
            </div>

            <div>
                <p class="text-sm font-medium text-gray-500">Service</p>
                <p class="mt-1">{{ service.name if service else 'N/A' }}</p>
            </div>

            <div>
                <p class="text-sm font-medium text-gray-500">Config</p>
                <p class="mt-1">{{ config.group_name if config else 'N/A' }}</p>
            </div>

            <div>
                <p class="text-sm font-medium text-gray-500">User</p>
                <p class="mt-1">{{ user.username if user else 'N/A' }}</p>
            </div>

            <div>
                <p class="text-sm font-medium text-gray-500">Device Type</p>
                <p class="mt-1">{{ sample.device_type_id or 'N/A' }}</p>
            </div>

            <!-- Type -->
            <div>
                <p class="text-sm font-medium text-gray-500">Type</p>
                <p class="mt-1">
                    {% if sample.type == 'daily' %}
                        Recurring
                    {% else %}
                        One-Time
                    {% endif %}
                </p>
            </div>

            <!-- Recurrence Interval (if recurring) -->
            {% if sample.type == 'daily' %}
            <div>
                <p class="text-sm font-medium text-gray-500">Recurrence Interval</p>
                <p class="mt-1">{{ sample.recurrence_interval or 'N/A' }}</p>
            </div>
            {% endif %}

            <div>
                <p class="text-sm font-medium text-gray-500">Start Date & Time</p>
                <p class="mt-1 text-gray-700">
                    {{ sample.start_datetime_str or 'N/A' }}
                </p>
            </div>

            {% if sample.type == 'daily' %}
            <div>
                <p class="text-sm font-medium text-gray-500">End Date</p>
                <p class="mt-1 text-gray-700">
                    {{ sample.end_date.strftime('%Y-%m-%d') if sample.end_date else 'N/A' }}
                </p>
            </div>
            {% endif %}

            <!-- Attached Photo -->
            <div>
                <p class="text-sm font-medium text-gray-500">Attached Photo</p>
                <p class="mt-1 font-semibold">{{ sample.photo_upload or 'N/A' }}</p>
            </div>

            <!-- Attached Document -->
            <div>
                <p class="text-sm font-medium text-gray-500">Attached Document</p>
                <p class="mt-1 font-semibold">{{ sample.document_upload or 'N/A' }}</p>
            </div>
        </div>

        <!-- Body Section -->
        <div class="bg-gray-50 px-8 py-6 border-t">
            <h3 class="font-semibold text-gray-800 text-lg mb-2">Full Message</h3>
            <p class="text-gray-600 leading-relaxed">{{ sample.body | striptags }}</p>
        </div>

        <!-- Logs Section -->
        <div class="bg-white px-8 py-6 border-t">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800 text-lg">Alert Logs</h3>
                <a href="{{ url_for('alert.list_logs', sample_id=sample.id) }}"
                   class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                    View All Logs for this Sample
                </a>
            </div>
            {% if logs %}
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left border border-gray-200 rounded-lg">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 font-semibold text-gray-700">Status</th>
                            <th class="px-4 py-2 font-semibold text-gray-700">Scheduled For</th>
                            <th class="px-4 py-2 font-semibold text-gray-700">Queued At</th>
                            <th class="px-4 py-2 font-semibold text-gray-700">Sent At</th>
                            <th class="px-4 py-2 font-semibold text-gray-700">Retries</th>
                            <th class="px-4 py-2 font-semibold text-gray-700">Error Message</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for log in logs %}
                        <tr>
                            <td class="px-4 py-2">{{ log.status }}</td>
                            <td class="px-4 py-2">{{ log.scheduled_for.strftime("%I:%M %p %Y-%m-%d") if log.scheduled_for else 'N/A' }}</td>
                            <td class="px-4 py-2">{{ log.queued_at.strftime("%I:%M %p %Y-%m-%d") if log.queued_at else 'N/A' }}</td>
                            <td class="px-4 py-2">{{ log.sent_at.strftime("%I:%M %p %Y-%m-%d") if log.sent_at else 'N/A' }}</td>
                            <td class="px-4 py-2">{{ log.retry_count }}</td>
                            <td class="px-4 py-2 text-red-600">{{ log.error_message or 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500">No logs found for this sample.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Enhanced Modal Structure -->
<div id="myModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
        <div class="text-center">
            <div id="modalIcon" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 text-red-600 mb-4">
                <!-- Icon will be dynamically set -->
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2" id="modalTitle"></h3>
            <p class="text-gray-600 mb-6" id="modalMessage"></p>
            <button id="closeModal" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Got It!
            </button>
        </div>
    </div>
</div>

<script>
    const testMessageButton = document.getElementById('testMessageButton');
    const myModal = document.getElementById('myModal');
    const closeModalButton = document.getElementById('closeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');

    testMessageButton.addEventListener('click', async () => {
        const sampleId = {{ sample.id }};
        const url = `{{ url_for('alert.test_sample_message', sample_id=sample.id) }}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // If you need to send data in the future, add a body here:
                // body: JSON.stringify({ key: 'value' }),
            });
            const data = await response.json();

            if (data.show_modal) {
                modalTitle.textContent = data.title || "Action Required"; // Use title from backend or default
                modalMessage.textContent = data.message;
                
                // Set icon and colors based on category (if provided)
                const modalIcon = document.getElementById('modalIcon');
                modalIcon.innerHTML = ''; // Clear previous icon
                modalIcon.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4'; // Reset classes

                if (data.category === 'danger') {
                    modalIcon.classList.add('bg-red-100', 'text-red-600');
                    modalIcon.innerHTML = '<svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                } else if (data.category === 'success') {
                    modalIcon.classList.add('bg-green-100', 'text-green-600');
                    modalIcon.innerHTML = '<svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                } else { // Default for info/action required
                    modalIcon.classList.add('bg-blue-100', 'text-blue-600');
                    modalIcon.innerHTML = '<svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }

                myModal.classList.remove('hidden');
                document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
            } else {
                if (data.flash_message) {
                    // To make flash messages work with AJAX, you typically need to:
                    // 1. Store the flash message in local storage or a cookie.
                    // 2. On page load, check for and display the stored flash message.
                    // 3. Clear the stored flash message.
                    // For simplicity and to avoid over-complicating the current task,
                    // we'll stick to redirecting, which will trigger Flask's native flash message rendering.
                    // If a more advanced AJAX flash message system is needed, it would be a separate task.
                    window.location.href = `{{ url_for('alert.detail_sample', id=sample.id) }}`;
                }
            }
        } catch (error) {
            console.error('Error:', error);
            modalTitle.textContent = "Error";
            modalMessage.textContent = "An unexpected error occurred. Please try again.";
            
            const modalIcon = document.getElementById('modalIcon');
            modalIcon.innerHTML = '<svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2A9 9 0 1112 3a9 9 0 019 9z"></path></svg>';
            modalIcon.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 text-red-600 mb-4';

            myModal.classList.remove('hidden');
            document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0');
            document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
        }
    });

    closeModalButton.addEventListener('click', () => {
        document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
        document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            myModal.classList.add('hidden');
        }, 300); // Match transition duration
    });

    // Close modal if clicked outside
    myModal.addEventListener('click', (event) => {
        if (event.target === myModal) {
            document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                myModal.classList.add('hidden');
            }, 300); // Match transition duration
        }
    });
</script>
{% endblock %}